    Copyright 2014 Google Inc. All rights reserved.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

        http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

# 同步协议和数据格式

对于会议数据从服务器同步的方式，我们引入了一个主要的改变： IOSched现在仅从一个配置文件中指定的URL加载JSON格式数据，而不是去请求指定的后台。

同步过程开始于发起一个加载manifest文件的HTTP GET请求。URL 由[Config.java](https://github.com/google/iosched/blob/master/android/src/main/java/com/google/samples/apps/iosched/Config.java)文件中的`MANIFEST_URL`常量配置。

在Google I/O中，我们使用了Google Cloud Storage作为云服务器来存储这些JSON文件，然而，如果你处理自己的事件，你没必要一定要用Google Cloud Storage，任何可靠的云服务皆可。

IOSched在对manifest文件的请求中发送一个`If-Modified-Since` HTTP header，指定了该文件上一次下载的时间戳。如果服务器返回HTTP 状态码304 (无修改)，IOSched则认为同步完成，结束操作，因为manifest文件没有更新。如果服务器返回200 OK，下一步就解析manifest数据。下面是manifest文件内容的示例：

```JSON
{
    "format": "iosched-json-v1",
    "data_files": [
        "past_io_videolibrary_v5.json",
        "experts_v11.json",
        "hashtags_v8.json",
        "blocks_v10.json",
        "map_v11.json",
        "keynote_v10.json",
        "partners_v2.json",
        "session_data_v2.681.json"
    ]
}
```

注意到`data_files`数组中的每一个条目实际上是指向另外一个JSON文件，分别包含每一种条目的具体信息。它们的名字并无特别之处，可以随意指定。我们的做法是添加版本计划作后缀 (`_v<N>.json`) 。

> 注意： 这些文件是通过**名字**缓存在app里，因此如果app在某时刻已经下载了`keynote_v10.json`，就不会再次下载它。因此，如果你用于自己的事件，每次你修改了一个文件，要确保同步修改它的名字。比如，重命名为`keynote_v11.json`(同时更新manifest)。简而言之， **一旦发布，每个文件即视为不可修改**。

所以通常更新一个或多个文件的步骤是：

1. 下载 foo_v1.json，修改，上传 foo_v2.json
2. 下载 bar_v7.json，修改，上传 bar_v8.json
3. 下载 manifest.json，改为指向 foo_v2 和 bar_v8，上传

> 注意顺序：你应该始终**最后**更新manifest文件，因为一旦你上传了它，它指向的文件就对用户可见了。

每一个JSON文件的格式是：

```JSON
    {
       "<entity_collection>": [
           <entity>,
           <entity>,
           <entity>
       ],
       "<entity_collection>": [
           <entity>,
           <entity>,
           <entity>
       ]
    }
```

每个文件由一个或多个条目的集合组成，根据类型组织起来。示例的条目集合有：sessions，speakers，rooms等。

在你写这些文件的时候，哪个集合存于哪个文件完全由你决定。比如，在我们这，我们把sessions，speakers和rooms的条目一起放在session_data_vN.json中，当然我们也可以放到3个JSON文件中。

这是一个包含room，session和speaker的例子:

```JSON
{
  "rooms": [
    {
        "id": "ROOM1",
        "name": "Room Alpha"
    }
  ],
  "sessions": [
    {
        "id": "SESSION1"
        "description": "A cool session about example data.",
        "title": "Example Data in Action",
        "url": "http://www.example.com",
        "tags": [
            "TYPE_SESSION",
            "TOPIC_ANDROID",
            "TOPIC_CHROME",
            "THEME_DEVELOP",
            "THEME_DESIGN"
        ]
        "startTimestamp": "2014-06-26T22:00:00Z",
        "endTimestamp": "2014-06-26T22:30:00Z",
        "youtubeUrl": "dQw4w9WgXcQ",
        "speakers": [
            "SPEAKER1"
        ],
        "room": "ROOM1",
        "isLivestream": true,
        "captionsUrl": "http://......"
    }
  ],
  "speakers": [
    {
        "id": "SPEAKER1",
        "name": "Example Smith",
        "bio": "Mr. Example Smith is a great speaker.",
        "plusoneUrl":  
            "https://plus.google.com/12345677890123456789012",
        "thumbnailUrl":
            "https://example.com/..."
    }
  ]
}
```

注意到3个集合("rooms"，"speakers" 和 "sessions")在一个文件中，如果放在3个文件中同样有效。

> **重要**：如果不止一个文件指定了同种条目的集合，IOSched会把这些集合联合起来。也就是说如果你有多个文件指定了sessions，它们最终会形成同一个sessions集合。


## Bootstrap 数据

当用户首次运行app的时候，它们期望看到数据。然而，如果我们仅仅依赖同步机制给app带来数据，用户首次使用时将会盯着白屏等待同步，这是一个不好的用户体验。

这就是为什么IOSched使用预加载的“bootstrap 数据”过渡，本质上是一个预加载的JSON数据离线快照。这份数据在app首次运行的时候会被解析并保存到数据库。

这份文件在这 [res/raw/bootstrap.json](https://github.com/google/iosched/blob/master/android/src/main/res/raw)。仅仅是一个包含服务器上的JSON文件联合快照的文本文件。


## 数据格式

下面是IOSched支持的每一个条目类型的格式文档。

### Rooms

Rooms 是 sessions 发生的地方。

```JSON
{
  "rooms": [
    <room>,
    <room>,
    <room>,
    ...
  ]
}
```
每一个 `<room>` 的格式：
```JSON
{
    "id": "ROOM1",
    "name": "Room Alpha"
}
```

### Blocks

Blocks是sessions或其他有趣的活动发生的时间段。Blocks仅仅在My 
Schedule页显示，告诉用户哪些是该event的主要blocks。比如，早餐和午餐就是blocks。

```JSON
{
  "blocks": [
    <block>,
    <block>,
    <block>,
    ...
  ]
}
```

表示一个进餐中断的`<block>`例子：

```JSON
{
    "title": "Lunch",
    "subtitle": "Cafe, Level 1", 
    "type": "break", 
    "start": "2014-06-25T18:30:00.000Z",
    "end": "2014-06-25T20:00:00.000Z"
}
```

表示一个自由中断的`<block>`例子：

```JSON
{
    "title": "",
    "type": "free",
    "subtitle": "",
    "start": "2014-06-25T18:00:00.000Z",
    "end": "2014-06-25T19:00:00.000Z"
}
```

这种block类型是`free`因为它在app的My Schedule中显示为自由中断，允许用户点击并且查看在该block的时间段内开始的sessions。每一个session的起始时间应该位于至少一个自由中断的时间段内，否则用户无法在My Schedule中添加到自己的日程。
重叠的 `free` blocks 在Android app中处理。

### Sessions

```JSON
{
  "sessions": [
    <session>,
    <session>,
    <session>,
    ...
  ]
}
```
每一个 `<session>` 的格式：

```JSON
{
   "id": "SESSION123"
   "url": "https://...."
   "title": "Web Components in Action",
   "description": "Web components are cool.",
   "tags": [
       "TYPE_SESSION",
       "TOPIC_ANDROID",
       "TOPIC_CHROME",
       "THEME_DEVELOP",
       "THEME_DESIGN"
   ]
   "mainTag": "TOPIC_ANDROID",
   "startTimestamp": "2014-06-25T22:10:00Z",
   "endTimestamp": "2014-06-25T22:55:00Z"
   "photoUrl": "https://...../photo.jpg",
   "youtubeUrl": "https://youtu.be/YCUZ01yFtsM",
   "speakers": [
       "SPEAKER123",
       "SPEAKER456"
   ],
   "room": "ROOM123",
   "isLivestream": true,
   "captionsUrl": "http://......",
   "color": "#607d8b",
   "hashtag": "webcomponents"
}
```

The session URL is the URL of the session on the web. This is also
used as the +1 URL when the user +1's the session.  The session tags are
not arbitrary, they have to be defined in the "tags" collection. The
start end end timestamps are always given in this format, in the UTC
timezone. The photo URL is the URL of the photo that illustrates
the session. The captions URL is the URL of a page to show the
livestream captions for this session. Set to "" if captions are not
available. Color is branding color that shows in the session
details screen, and the hashtag is the Google+ hashtag that gets
automatically added when the user clicks the "Social" button on the
session details screen.

If isLivestream is set to true, this session is livestreamed, and
the youtubeUrl indicates the Youtube livestream URL to view it.
If the session is not livestreamed, then youtubeUrl indicates
the URL of the video recording of the session, if one is available.

    
### Speakers

A speaker is a presenter of a session. Each session can have
zero or more presenters. Sessions with at least one presenter
are more fun.

```JSON
{
  "speakers": [
    <speaker>,
    <speaker>,
    <speaker>,
    ...
  ]
}
```

Example of speaker:

```JSON
{
    "id": "SPEAKER123",
    "name": "Reto Meier",
    "bio": "Reto is the lead of the Scalable Developer Advocacy team",
    "company": "Google",
    "thumbnailUrl": "http://..../reto.jpg",
    "plusoneUrl": "https://plus.google.com/+RetoMeier"
}
```

### Tags

Tags are what you expect tags to be. They help classify sessions.
In IOSched, a session is tagged by TOPIC, THEME and TYPE.
Examples of TOPIC tags: "Android", "Chrome", etc. Examples of
THEME tags: "Design", "Develop", "Distribute". And some examples
of TYPE tags are: "Session", "Codelab", "Office hours", etc. 
The "tags" entity in the data specifies all the possible tags and the
categories they belong to.

```JSON
{
  "tags": [
    <tag>,
    <tag>,
    <tag>,
    ...
  ]
}
```

Example of tag representing the "Android" topic:

```JSON
{
    "category": "TOPIC",
    "tag": "TOPIC_ANDROID",
    "name": "Android",
    "abstract": "",
    "order_in_category": 1,
    "color": "#558b2f"
}
```

Notice that we indicate that this tag belongs to the "TOPIC"
category, which is to say this tag represents the topic of a session.

Example of tag representing the "Develop" theme:

```JSON
{
    "category": "THEME",
    "tag": "THEME_DEVELOP",
    "name": "Distribute",
    "abstract": "",
    "order_in_category": 2
}
```

And finally, here is an example of the tag that represents the
"Office Hours" session type:

```JSON
{
    "category": "TYPE",
    "tag": "TYPE_OFFICEHOURS",
    "name": "Office Hours",
    "abstract": "",
    "order_in_category": 6
}
```

The *order_in_category* parameter is used when showing lists of tags,
and it indicates the relative ordering of tags in the same category.
So when we are showing a list of session types, "Office Hours" will
appear after any tag with *order_in_category* lower than 6, and before
any other tag with *order_in_category* bigger than 6.


### Experts

Experts are the Google Developer Experts that appear in the 
"Experts" screen of the app.

```JSON
{
  "experts": [
    <expert>,
    <expert>,
    <expert>,
    ...
  ]
}
```

Example of expert:

```JSON
{
    "id": "EXPERT123",
    "name": "Bruno Oliveira", 
    "attending": true, 
    "bio": "Lorem ipsum dolor sit amet", 
    "city": "Sao Paulo, SP", 
    "country": "Brazil", 
    "imageUrl": "https://....../photo.jpg",
    "plusId": "+BrunoOliveira",
    "url": "https://plus.google.com/+BrunoOliveira"
} 
```

### Hashtags

Hashtags are the hashtags that appear in the "Social" screen.

```JSON
{
  "hashtags": [
    <hashtag>,
    <hashtag>,
    <hashtag>,
    ....
  ]
}
```

Example hashtag:

```JSON
{
    "color": "#ff8a65",
    "description": "Experience the magic of I/O remotely",
    "name": "#io14extended",
    "order": 11
}
```

### Partners

Partners are companies whose information appears in the list of
partners in the map.

```JSON
{
  "partners": [
    <partner>,
    <partner>,
    <partner>,
    ...
  ]
}
```

Example partner:

```JSON
{
    "id": "PARTNER123", 
    "name": "Example Corp", 
    "website": "http://www.example.com/", 
    "logo": "http://.../example.png",
    "desc": "Example Corp produces great example material."
} 
```


### Videos

Videos are links to Youtube content that appear in the Video Library
screen.

```JSON
{
  "videos": [
    <video>,
    <video>,
    <video>,
    ...
  ]
}
```
Example video:

```JSON
{
    "year": "2013",
    "title": "What's New in Android Developer Tools",
    "desc": "A summary of new features for Android developers",
    "vid": "lmv1dTnhLH4",
    "id": "lmv1dTnhLH4",
    "thumbnailUrl": "http://img.youtube.com/vi/lmv1dTnhLH4/hqdefault.jpg",
    "topic": "Android",
    "speakers": "Xavier Ducrohet, Tor Norbye"
}
```
`vid` is the Youtube video ID of this video.

> NOTE: due to a bug in the Android app, "id" must always be set to the same as "vid".

### Map

The map data is different from the others because it's not a
collection of entities. Rather, it is a single JSON object
formatted as follows:

```JSON
{
  "map": [
  {
     "config": {
         "enableMyLocation": "false"
     }, 
     "markers": {
         "0": [
             {
                  "id": "ROOM8", 
                  "lat": 37.78280631538293, 
                  "lng": -122.40401487797499, 
                  "title": "Room 8", 
                  "type": "session"
             }, 
             ....
         ],
         "1": [
             //...more markers...
         ],
         "2": [
             //...more markers...
         ],
     },
     "tiles": {
         "0": {
             "filename": "floor2-2014-v1.svg", 
             "url": ""
         }, 
         "1": {
             "filename": "floor1-2014-v1.svg", 
             "url": ""
         }, 
         "2": {
             "filename": "floor0-2014-v1.svg", 
             "url": ""
         }
     }
  }
  ]
}
```

`enableMyLocation` indicates whether indoor location should be enabled
in the indoor map. Each marker in the `markers` array represents
one of the markers on the map, with ID, latitute, longitude,
title and type. Markers are organized per floor (hence the 
"0", "1" and "2" keys).

To indicate the location of a room, use this marker format:

```JSON
{
     "id": "ROOM8", 
     "lat": 37.78280631538293, 
     "lng": -122.40401487797499, 
     "title": "Room 8", 
     "type": "session"
}
```

To put a label on the map without making it a marker, simply
set the "type" to "label":

```JSON
{
    "id": "gearpickup", 
    "lat": 37.78331825838168, 
    "lng": -122.40340635180475, 
    "title": "Gear Pickup", 
    "type": "label"
}
```

To put the partners marker (which will open the list of partners
when clicked), use the "partnerlabel" type:

```JSON
{
    "id": "partnersandboxlabel", 
    "lat": 37.78325148340904, 
    "lng": -122.40336142480373, 
    "title": "Partner\nSandbox", 
    "type": "partnerlabel"
}
```

The "tiles" dictionary indicate what SVG file to use as the map
overlay for each floor. The optional "url" parameter indicates a
location where to download the file from, in case the file is not pre-loaded
on the app (as is the case in the example).


